<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide Example</title>
</head>
<body>
    <h1>Pyodide with NumPy and Matplotlib</h1>
    <button onclick="runPython()">Run Python Code</button>
    <div id="output"></div>

    <!-- Load Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.1/pyodide.js"></script>
    
    <script type="text/javascript">
        async function loadPyodideAndPackages() {
            // Load Pyodide and the necessary packages (numpy, matplotlib, cycler)
            let pyodide = await loadPyodide();
            await pyodide.loadPackage(["numpy", "matplotlib", "cycler"]);
            return pyodide;
        }

        async function runPython() {
            // Load Pyodide and packages
            const pyodide = await loadPyodideAndPackages();

            // Python code to run
            const pythonCode = `
import numpy as np
import matplotlib.pyplot as plt
import io
from matplotlib.backends.backend_agg import FigureCanvasAgg as FigureCanvas
from IPython.display import display

# Generate some data
x = np.linspace(0, 10, 100)
y = np.sin(x)

# Create a figure and plot
fig, ax = plt.subplots()
ax.plot(x, y)

# Save plot to a PNG image in a memory buffer
buf = io.BytesIO()
canvas = FigureCanvas(fig)
canvas.print_png(buf)

# Return the image data to JavaScript
buf.seek(0)
image_data = buf.getvalue()
image_data
            `;

            // Execute the Python code
            const result = await pyodide.runPythonAsync(pythonCode);

            // Convert image data to base64 and display it in the browser
            const base64Image = arrayBufferToBase64(result);
            document.getElementById("output").innerHTML = `<img src="data:image/png;base64,${base64Image}" />`;
        }

        // Helper function to convert ArrayBuffer to Base64 string
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
    </script>
</body>
</html>

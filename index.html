<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide Example</title>
</head>
<body>
    <h1>Pyodide với NumPy và Matplotlib</h1>
    <button onclick="runPython()">Chạy mã Python</button>
    <div id="output"></div>

    <!-- Tải Pyodide -->
    <script src="https://cdn.jsdelivr.net/npm/pyodide@0.23.1/pyodide.js"></script>
    
    <script type="text/javascript">
        async function loadPyodideAndPackages() {
            // Tải Pyodide và các gói cần thiết (numpy, matplotlib, cycler)
            let pyodide = await loadPyodide();
            await pyodide.loadPackage(["numpy", "matplotlib", "cycler"]);
            return pyodide;
        }

        async function runPython() {
            // Tải Pyodide và các gói
            const pyodide = await loadPyodideAndPackages();

            // Mã Python để chạy
            const pythonCode = `
import numpy as np
import matplotlib.pyplot as plt
import io
from matplotlib.backends.backend_agg import FigureCanvasAgg as FigureCanvas

# Tạo dữ liệu
x = np.linspace(0, 10, 100)
y = np.sin(x)

# Tạo hình ảnh và vẽ đồ thị
fig, ax = plt.subplots()
ax.plot(x, y)

# Lưu đồ thị vào bộ nhớ dưới dạng hình ảnh PNG
buf = io.BytesIO()
canvas = FigureCanvas(fig)
canvas.print_png(buf)

# Trả về dữ liệu hình ảnh cho JavaScript
buf.seek(0)
image_data = buf.getvalue()
image_data
            `;

            // Thực thi mã Python
            const result = await pyodide.runPythonAsync(pythonCode);

            // Chuyển đổi dữ liệu hình ảnh sang base64 và hiển thị trong trình duyệt
            const base64Image = arrayBufferToBase64(result);
            document.getElementById("output").innerHTML = `<img src="data:image/png;base64,${base64Image}" />`;
        }

        // Hàm hỗ trợ chuyển đổi ArrayBuffer thành chuỗi Base64
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
    </script>
</body>
</html>
